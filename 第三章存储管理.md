# 第三章存储管理
在pgsql中，有专门的模块负责管理存储设备，称之为存储管理器。存储管理器提供了一组统一的管理外存与内存资源的功能模块，所有对外存与内存的操作都将交由存储管理器处理，可以认为存储管理器是数据库管理系统与物理存取设备的接口。与pgsql其他模块相比，存储管理器处在系统结构的底层，包含了操作物理存取设备的接口。

## 3.1 存储器管理的体系结构
&ensp;pgsql的存储管理主要包括两个功能：内存管理和外存管理。除了管理内存和外存的交互外，存储管理器的另一个主要任务是对内存进行统筹安排和规划。存储管理器体系结构如下图所示。
![memorymanagesystem.jpg](https://s1.ax1x.com/2020/06/19/NueRDP.jpg)
&ensp;内存管理包括共享内存的管理以及进程本地内存的管理。在共享内存中存储着所有进程的公共数据，例如锁变量，进程通信、缓冲区等。本地内存为每个后台进程所专有，是它们的工作区域，存储着属于该进程的Cache、事务管理信息、进程信息等。pgsql提供了轻量级锁，用于支持对共享内存中统一数据的互斥访问。存储管理器还提供了内存上下文(memorycontext)用于统一管理内存的分配和回收，从而更加有效安全地对内存进行管理。</br>
&ensp;外存管理包括表文件管理、空闲文件管理、虚拟文件描述符管理及大数据存储管理等。在pgsql中，**每一个表都用一个文件（表文件）存储**，表文件以表的oid命名。超出操作系统文件大小限制的表，pgsql会自动切成多个文件来存储，并自动按顺序标号标识它们。每个表除了表文件以外还有两个附属文件：可见性映射表文件(VM)和空闲空间映射表(FSM)文件。前者用于加快清理操作(VACUUM)的执行速度，后者用于表文件空闲空间的管理。</br>
&ensp;pgsql采用了份也存储管理方式，数据在内存中是以页面块的形式存在。每个表文件由多个BLCKSZ(可配置的常量)字节大小的文件块组成，每个文件块又可以包含多个元组。表文件以文件块为单位读入内存中，每一个文件块在内存中形成一个页面块。页面块是文件块在内存中的存在形式，后文也用页面来指代文件块。一个文件块可以存放多个元组，但是pgsql不支持元组的跨块存储，每个元组最大为MaxHeapTupleSize。这样保证了每个文件块存储的是多个完整的元组（思考，会不会造成存储区域的浪费）</br>
&ensp;pgsql在内存中开辟了缓冲区域用于存储这些文件块，我们将其在内存中开辟的缓冲区称为缓冲池，缓冲池被划分为若干个固定大小的缓冲区，磁盘上的文件块在读入内存后被存放在缓冲区中，称之为页面块或者缓冲块。BLCKSZ的默认值是8192，因此一个标准缓冲块的默认大小也是8KB。</br>

总体来说，存储管理器的主要任务包括：
> 1. 缓冲池管理：缓冲池在pgsql中起缓存作用。数据库中的事务常常需要频繁地存取数据，为减少对磁盘的读写，在事务执行时，数据首先将会放入缓冲池中，pgsql设立了进程间共享的缓冲池以及进程私有的缓冲池（本地缓冲池）
> 2. cache机制：将进程最近使用的一些是系统数据缓存在私有内存中，其级别高于缓冲池。
> 3. 虚拟文件描述符：pgsql通过虚拟文件描述符(virtual file descriptor,VFD)来对物理文件进行管理，避免因为操作系统对进程打开文件数的限制出现错误。
> 4. 空闲空间管理：用于快速定位到表文件中的空闲空间以便于插入新数据，从而提高空间利用率。
> 5. 进程间通信机制（IPC）：pgsq是一个多进程的系统，IPC用来在多个后台进程间进行通信和消息的传递，比如使用消息队列来同步进程产生的无效消息，同时IPC还提供了对共享内存的管理。
> 6. 大数据存储管理：提供大对象和TOAST机制。大对象机制是一个由用户控制的大数据存储方法。它允许用户调用函数，通过SQL语句直接向表中插入一个大尺寸文件（图片、视频等）。而TOAST机制是在用户插入的变长数据超过一定限制后自动触发，用户无法对TOAST加以控制。

&ensp;当一个pgsql进程从数据库读写一个元组的时候，可以用下图来描述。
![rwtuple.jpg](https://s1.ax1x.com/2020/06/19/NutkSx.jpg)
> 1. 读取一个元组数据时，首先获取表的基本信息（oid,索引统计等）及元组的模式信息，这些信息被记录在多个系统表中。通常表模式表化率很低，为了减少对系统表的访问，进程的本地内存区域设置了两种cache，一种用来存储系统表元组，一种用来存储表的基本信息。
> 2. 接下来要读区元组所在的文件块获得元组的数据。pgsql进程将首先从共享缓冲池中查找所需文件对应的缓冲块。如果找到就直接从中取得元组的数据并配合上一步得到的模式信息解析出元组的各个属性值。如果找不到，读入文件块，从被调入的缓冲块中获取元组数据。本地缓冲池用于缓存临时表数据及其它进程不可见数据。
> 3. 如果缓冲池没有包含所需元组，则要从存储介质中获取，并写入到缓冲区中。缓冲区与存储介质的交互是通过存储介质管理器(SMGR)进行的。不同存储介质的底层实现有差异，SMGR负责通关各种介质，并对上层的请求提供统一的接口，对下层则根据不同介质调用相应的介质管理器，因此SMGR是pgsql外存管理部分的核心。不仅支持对磁盘的管理，磁盘管理器负责管理所有存储在磁盘上的文件的操作，包括创建、删除、读取等。
> 4. 虚拟文件描述符机制(VFD)是为了防止程序打开的文件超过系统的限制引起的位置错误。
> 5. 在写元组时，需要找到一个合适空闲空间的缓冲块，然后填入缓冲块。如果便利所有空闲空间，效率很低，因此pgsql为每个表增加了一个附属文件，即空闲空间映射表(FSM)，用于记录每个表文件块的空闲空间大小。
> 6. pgsql使用表计删除的方式处理元组的删除操作，并非从物理上删除，而清楚工作由VACUUM机制来完成。遍历所有文件块查找被删除的元组效率很低。因此设置了可见性映射表(VM)加快查找速度。
> 7. 大数据的存储使用TOASt机制和大对象机制来实现，前者主要用于变长字符串，后者主要用于大尺寸的文件。写入元组时，如果超过大小限制，会自动触发TOAST机制对该元组进行相应处理。大对象机制则由用户来调用，当用户需要在数据库中存放一个大文件时，可以调用pgsql提供的接口函数创建一个大对象并获得oid，用户通过大对象oid来存储并使用大对象。